<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DREAM IT by Rafael Gimeno</title>
  <!-- Se incluye JSZip para descomprimir archivos MXL -->
  <script src="https://cdn.jsdelivr.net/npm/webmidiapishim@1.0.7/dist/shim.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@latest/build/opensheetmusicdisplay.min.js"></script>
  <style>
    /* Cabecera fija */
    #header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 120px;
      background-color: #add8e6;
      border-bottom: 4px solid #00008B;
      z-index: 1000;
      box-sizing: border-box;
      padding: 10px 20px;
    }
    #header h1 {
      margin: 0;
      font-size: 3em;
      font-family: Segoe UI Black, Haettenschweiler, "Arial Narrow Bold", sans-serif;
      color: #00008B;
      text-align: center;
      line-height: 1.2;
      text-decoration: underline;
    }
    /* Subcabecera que contiene el marcador, by Rafael Gimeno y Dispositivo MIDI */
    .subheader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 5px;
      position: relative;
    }
    .subheader h2 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 1em;
      font-family: "Times New Roman", Times, serif;
      color: #000000;
      line-height: 1.2;
      text-align: center;
    }
    .subheader h2 a {
      color: inherit;
      text-decoration: none;
    }
    .subheader h2 a:hover {
      text-decoration: underline;
    }
    #midiInfo {
      font-family: sans-serif;
      font-size: 0.9em;
      color: #000000;
    }
    /* Marcador de aciertos estilo "cuadro" similar a elegir archivo */
    #scoreboard {
      padding: 8px 12px;
      background-color: green;
      color: white;
      border: 1px solid #ccc;
      font-family: sans-serif;
      border-radius: 8px;
      font-size: 1.0em;
    }
    /* Contenedor fijo de controles (botones) */
    .controls {
      position: fixed;
      top: 120px;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #add8e6;
      border-bottom: 2px solid #00008B;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 900;
      box-sizing: border-box;
    }
    .left-control {
      position: absolute;
      left: 20px;
    }
    .right-control {
      position: absolute;
      right: 20px;
    }
    .middle-control {
      text-align: center;
    }
    #fileLabel {
      padding: 8px 12px;
      background-color: green;
      color: white;
      border: 1px solid #ccc;
      cursor: pointer;
      font-family: sans-serif;
      border-radius: 8px;
    }
    /* Se aceptan .xml, .musicxml y .mxl */
    #fileInput {
      display: none;
    }
    .middle-control button {
      margin: 0 10px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-family: sans-serif;
      color: white;
      border-radius: 8px;
      background-color: dodgerblue;
    }
    #toggleLocal {
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-family: sans-serif;
      color: white;
      border-radius: 8px;
    }
    /* Contenedor de la partitura */
    #score {
      border: 4px solid #00008B;
      margin: 200px auto 20px;
      min-height: 600px;
      width: 90%;
      background-color: white;
    }
    /* Overlay final: centrado en la pantalla */
    #finalMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      font-family: sans-serif;
      font-size: 1.8em;
      text-align: center;
      border: 4px solid #00008B;
      border-radius: 8px;
      z-index: 3000;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Cabecera fija -->
  <div id="header">
    <h1>DREAM IT</h1>
    <div class="subheader">
      <div id="scoreboard">ACIERTOS: 0 | ERRORES: 0</div>
      <h2>
        © <a href="https://www.youtube.com/@rafgim" target="_blank">by Rafael Gimeno</a>
      </h2>
      <div id="midiInfo">Dispositivo MIDI: No detectado</div>
    </div>
  </div>
  
  <!-- Contenedor fijo de controles -->
  <div class="controls">
    <div class="left-control">
      <label id="fileLabel" for="fileInput">Elegir archivo .musicxml / .mxl</label>
      <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
    </div>
    <div class="middle-control">
      <button id="btnRetroceder">◀ Retroceder</button>
      <button id="btnAvanzar">Avanzar ▶</button>
    </div>
    <div class="right-control">
      <button id="toggleLocal">MIDI Local Control: OFF</button>
    </div>
  </div>
  
  <!-- Contenedor de la partitura -->
  <div id="score"></div>
  
  <!-- Overlay para el mensaje final -->
  <div id="finalMessage"></div>
  
  <script>
    let osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", { drawingParameters: "default" });
    let scoreEvents = [];
    let currentEventIndex = 0;
    let midiOutput = null;
    let activeTiedNotes = new Set();
    let midiBuffer = new Set();
    let lastNoteTime = 0;
    const NOTE_GROUPING_TIME = 30;
    
    let sustainPedalActive = false;
    let activeScoreEvents = [];
    let localControlEnabled = false;
    
    // Contador de aciertos y errores
    let correctCount = 0;
    let errorCount = 0;
    
    // Array de 100 frases crueles y graciosas.
    const finalPhrases = [      
      "¡Vaya, hoy las notas decidieron jugar a las escondidas!",
      "¡Ups! Parece que el compás se te escapó hoy.",
      "¡No te preocupes! Hasta los grandes tienen días sin ritmo.",
      "¡Epa! La partitura se puso de mal humor contigo.",
      "¡Casi! Pero parece que las teclas se tomaron un descansito.",
      "¡Tranquilo! Cada error es un paso hacia la mejora.",
      "¡Buen intento! Las notas siguen esperando su turno.",
      "¡Ouch! No fue tu mejor día musical, pero ríete de ello.",
      "¡Jaja! La sinfonía se rió un poco de tus fallos.",
      "¡Vaya, qué curioso! Hoy el compás jugó en tu contra.",
      "¡Ánimo! Cada error es solo un preludio a la grandeza.",
      "¡Qué divertido! Pareces improvisar con chispa.",
      "¡Sigue intentándolo! Hoy las notas están de broma.",
      "¡Interesante! Tus errores tienen su propio ritmo.",
      "¡Ja! La partitura tiene un sentido del humor especial contigo.",
      "¡Eso fue inesperado! Quizá las teclas se tomaron un recreo.",
      "¡Ríe y sigue! La música es una aventura, no una competencia.",
      "¡Carcajadas! Parece que las notas se divirtieron a tu costa.",
      "¡Venga, a reír! Cada fallo es una anécdota musical.",
      "¡No te rindas! Incluso los maestros tuvieron días así.",
      "¡Oye! Tus errores tienen estilo, ¡sigue adelante!",
      "¡Fantástico! Aunque fallaste, al menos lo hiciste con gracia.",
      "¡Qué original! Tu interpretación tiene un toque único.",
      "¡Esos compases son toda una comedia musical!",
      "¡De risa! Cada error es un chiste bien contado.",
      "¡No te lo tomes tan en serio! La música también es diversión.",
      "¡Vamos, sigue practicando! Cada fallo es una oportunidad en potencia.",
      "¡Qué show! Tus errores casi forman parte del espectáculo.",
      "¡Lo hiciste a tu manera! Un poco de improvisación nunca está de más.",
      "¡Ríe y sigue! Hoy las notas decidieron tomarse un recreo.",
      "¡Nada mal! Tus errores hacen que la partitura sea más entretenida.",
      "¡Un día peculiar! Las teclas se pusieron creativas hoy.",
      "¡Divertido intento! La música sabe reírse contigo.",
      "¡Sigue adelante! Cada fallo es una oportunidad para mejorar.",
      "¡Bien, casi lo tienes! La improvisación es un arte.",
      "¡Eso fue inesperado! Las notas tienen sentido del humor.",
      "¡Vaya, qué ocurrencia! Tus errores son dignos de una anécdota.",
      "¡Relájate! La partitura tiene días de humor variable.",
      "¡Menos mal que es solo música! Ríete de ti mismo.",
      "¡Qué gracioso! Tus notas crean una historia divertida.",
      "¡Inténtalo de nuevo! Cada fallo es una risa en la historia musical.",
      "¡Oye, no pasa nada! Hasta los grandes tienen días raros.",
      "¡Bien ahí! La risa es el mejor acompañante del error.",
      "¡Un paso en falso, pero con estilo!",
      "¡A reír se ha dicho! La música te invita a disfrutar.",
      "¡Esa fue una jugada inesperada! La partitura se quedó de piedra.",
      "¡No te lo tomes a pecho! Cada fallo es parte de tu comedia personal.",
      "¡Jaja, qué ocurrencia! Las teclas te hicieron una broma hoy.",
      "¡Bien, casi lo tienes! Los errores son parte del show.",
      "¡Una interpretación única! Aunque no aciertas, se nota tu estilo.",
      "¡Sigue practicando! Los errores te hacen más humano.",
      "¡De lo más divertido! Tus fallos tienen su propia melodía.",
      "¡Ríe y mejora! La música es un viaje lleno de sorpresas.",
      "¡No te lo tomes a pecho! Cada fallo es parte de la sinfonía de la vida.",
      "¡Una aventura musical! Tus errores son casi intencionales.",
      "¡Un toque de humor en cada compás, sigue así!",
      "¡Sigue intentándolo! Incluso los errores pueden sonar bien.",
      "¡Inesperado y divertido! Tus notas crean momentos únicos.",
      "¡No te detengas! Cada fallo te acerca a un gran acierto.",
      "¡Un poco de improvisación nunca está de más!",
      "¡Lo hiciste con gracia, aunque no fuera perfecto!",
      "¡Divertido intento! La música es un juego, ríete de los tropiezos.",
      "¡Nada mal! A veces los errores son la mejor parte de la actuación.",
      "¡Sigue practicando! Los mejores músicos también tienen tropiezos.",
      "¡Con humor se avanza! Cada nota fallida es una broma musical.",
      "¡A reír se ha dicho! La partitura aprecia tu autenticidad.",
      "¡Qué simpático! Aunque no aciertes, lo haces con estilo.",
      "¡Pura improvisación! Tus errores son parte del encanto.",
      "¡Ríe y sigue! La música te sonríe, incluso en los tropiezos.",
      "¡Menos mal que es solo música! Cada error te enseña algo nuevo.",
      "¡Sigue adelante! La risa es la mejor respuesta a un fallo.",
      "¡Bien jugado! Tus errores hacen la actuación memorable.",
      "¡No pasa nada! Cada compás fallido es una anécdota divertida.",
      "¡Divertido y único! Tu interpretación es irrepetible.",
      "¡Ríe, que la música es para disfrutar, errores incluidos!",
      "¡Con humor se aprende! Cada error es un paso hacia el éxito.",
      "¡Un toque cómico en cada nota, sigue practicando!",
      "¡Muy gracioso! La sinfonía aprecia tu sinceridad musical.",
      "¡Sigue intentándolo! Incluso los errores tienen su encanto.",
      "¡Una interpretación memorable! Tus fallos son parte del viaje.",
      "¡Con cada compás, te acercas a la perfección – ríe de los errores!",
      "¡No te rindas! La música es un juego y cada error es diversión.",
      "¡Sigue adelante con humor! Cada nota fallida es una anécdota.",
      "¡Una risa en cada compás, sigue mejorando!",
      "¡Qué divertido! La partitura se alegra con cada intento.",
      "¡Tus errores tienen su propio ritmo, y eso es genial!",
      "¡La risa es parte del arte! Sigue tocando y aprendiendo.",
      "¡Continúa en el camino! Cada error te hace único y divertido.",
      "¡No te detengas! La música es una comedia de la vida, sigue adelante!",
      "¡Una lección en cada compás, y la risa nunca falta!",
      "¡Fabuloso! Con más del 90 % de aciertos, ¡eres un prodigio musical!",
      "¡Increíble! Más del 90 % de aciertos; la orquesta te aclama.",
      "¡Excepcional! Tu precisión supera el 90 %, ¡enhorabuena de verdad!",
      "¡Magnífico! Con más del 90 % de aciertos, la sinfonía brilla para ti.",
      "¡Estelar! Superaste el 90 %; ¡tu talento es innegable!",
      "¡Sobresaliente! Más del 90 % de aciertos; ¡eres una leyenda musical!",
      "¡Impecable! Con más del 90 % de aciertos, la música te rinde homenaje.",
      "¡Perfecto! Más del 90 % de aciertos; ¡has alcanzado la perfección musical!",
      "¡De otro mundo! Con más del 90 % de aciertos, ¡la sinfonía se rinde ante ti!",
      "¡Monumental! Has logrado un 100 % de aciertos; ¡eres insuperable!",
      "¡Legendario! Con un 100 % de aciertos, tu talento trasciende la música."
    ];
    
    // Reinicia contadores, colores y scroll
    function resetState() {
      correctCount = 0;
      errorCount = 0;
      updateScoreboard();
      document.querySelector("h1").style.color = "#00008B";
      document.getElementById("scoreboard").style.backgroundColor = "green";
      document.getElementById("score").style.borderColor = "#00008B";
      document.getElementById("header").style.borderBottomColor = "#00008B";
      document.querySelector(".controls").style.borderBottomColor = "#00008B";
      window.scrollTo(0, 0);
    }
    
    function updateLocalControl() {
      const btn = document.getElementById("toggleLocal");
      if (localControlEnabled) {
        btn.textContent = "MIDI Local Control: ON";
        btn.style.backgroundColor = "green";
        if (midiOutput) {
          try {
            midiOutput.send([0xB0, 122, 127]);
          } catch (err) {
            console.error("Error enviando mensaje MIDI para activar control local:", err);
            document.getElementById("midiInfo").textContent = "Dispositivo MIDI: NO VALIDO";
            document.getElementById("midiInfo").style.color = "red";
          }
        }
      } else {
        btn.textContent = "MIDI Local Control: OFF";
        btn.style.backgroundColor = "red";
        if (midiOutput) {
          try {
            midiOutput.send([0xB0, 122, 0]);
          } catch (err) {
            console.error("Error enviando mensaje MIDI para desactivar control local:", err);
            document.getElementById("midiInfo").textContent = "Dispositivo MIDI: NO VALIDO";
            document.getElementById("midiInfo").style.color = "red";
          }
        }
      }
    }
    
    document.getElementById("toggleLocal").addEventListener("click", function() {
      localControlEnabled = !localControlEnabled;
      updateLocalControl();
    });
    updateLocalControl();
    
    async function loadAndRender(musicXML) {
      // Ocultar mensaje final y reiniciar estado (incluido el scroll)
      document.getElementById("finalMessage").style.display = "none";
      resetState();
      try {
        console.log("Cargando MusicXML...");
        await osmd.load(musicXML);
        osmd.render();
        console.log("Partitura renderizada correctamente.");
        osmd.cursor.reset();
        osmd.cursor.show();
        setTimeout(() => {
          console.log("Extrayendo eventos...");
          extractScoreEvents();
          addMeasureClickListeners();
        }, 1000);
      } catch (error) {
        console.error("Error al cargar/renderizar el MusicXML:", error);
      }
    }
    
    document.getElementById("fileInput").addEventListener("change", function(e) {
      let file = e.target.files[0];
      if (!file) return;
      const fileName = file.name.toLowerCase();
      if (fileName.endsWith(".mxl")) {
        console.log("Archivo MXL detectado.");
        let reader = new FileReader();
        reader.onload = function(e) {
          JSZip.loadAsync(e.target.result)
            .then(zip => {
              console.log("Archivo MXL descomprimido. Archivos encontrados:", Object.keys(zip.files));
              if(zip.files["META-INF/container.xml"]) {
                return zip.file("META-INF/container.xml").async("string")
                  .then(containerXML => {
                    console.log("container.xml leído:", containerXML.substring(0,200));
                    let parser = new DOMParser();
                    let xmlDoc = parser.parseFromString(containerXML, "application/xml");
                    let rootfileElement = xmlDoc.querySelector("rootfile");
                    if(rootfileElement) {
                      let fullPath = rootfileElement.getAttribute("full-path");
                      console.log("Archivo principal indicado en container.xml:", fullPath);
                      return zip.file(fullPath).async("string");
                    } else {
                      console.error("No se encontró elemento rootfile en container.xml");
                      throw new Error("No se encontró elemento rootfile en container.xml");
                    }
                  });
              } else {
                let xmlFile = null;
                for (let filename in zip.files) {
                  if (filename.toLowerCase().endsWith(".xml") || filename.toLowerCase().endsWith(".musicxml")) {
                    xmlFile = filename;
                    break;
                  }
                }
                if (xmlFile) {
                  console.log("Archivo XML encontrado en el MXL:", xmlFile);
                  return zip.file(xmlFile).async("string");
                } else {
                  throw new Error("No se encontró ningún archivo XML dentro del MXL.");
                }
              }
            })
            .then(musicXML => {
              currentEventIndex = 0;
              loadAndRender(musicXML);
              // Limpiar el input para permitir volver a cargar el mismo archivo
              document.getElementById("fileInput").value = "";
            })
            .catch(err => {
              console.error("Error al descomprimir el archivo MXL:", err);
            });
        };
        reader.readAsArrayBuffer(file);
      } else {
        let reader = new FileReader();
        reader.onload = function(e) {
          let musicXML = e.target.result;
          currentEventIndex = 0;
          loadAndRender(musicXML);
          document.getElementById("fileInput").value = "";
        };
        reader.readAsText(file);
      }
    });
    
    function extractScoreEvents() {
      scoreEvents = [];
      if (!osmd.sheet || !osmd.sheet.sourceMeasures || osmd.sheet.sourceMeasures.length === 0) {
        console.warn("No se encontraron compases en osmd.sheet.");
        return;
      }
      osmd.sheet.sourceMeasures.forEach((measure, mIndex) => {
        measure.verticalSourceStaffEntryContainers.forEach((verticalEntry) => {
          let rightHandPitches = [];
          let leftHandPitches = [];
          verticalEntry.staffEntries.forEach((staffEntry, staffIndex) => {
            staffEntry.voiceEntries.forEach(ve => {
              ve.notes.forEach(note => {
                let midi = getMidiPitch(note);
                if (midi !== undefined) {
                  let isTied = note.NoteTie;
                  if (isTied) {
                    if (activeTiedNotes.has(midi)) {
                      activeTiedNotes.delete(midi);
                    } else {
                      activeTiedNotes.add(midi);
                      (staffIndex === 0 ? rightHandPitches : leftHandPitches).push(midi);
                    }
                  } else {
                    (staffIndex === 0 ? rightHandPitches : leftHandPitches).push(midi);
                  }
                }
              });
            });
          });
          if (rightHandPitches.length > 0 || leftHandPitches.length > 0) {
            scoreEvents.push({ measure: mIndex, rightHandPitches, leftHandPitches });
          }
        });
      });
      console.log("scoreEvents:", scoreEvents);
    }
    
    function getMidiPitch(note) {
      return note.pitch && note.pitch.halfTone !== undefined ? note.pitch.halfTone + 12 : undefined;
    }
    
    function addMeasureClickListeners() {
      const measureElements = document.querySelectorAll("g.vf-measure[id]");
      console.log("Encontrados", measureElements.length, "compases con 'id'.");
      
      const measureNumbers = Array.from(measureElements).map(me =>
        parseInt(me.getAttribute("id").replace(/\D/g, ""), 10)
      );
      const startsAtZero = Math.min(...measureNumbers) === 0;
      console.log("Los números de compás empiezan en", startsAtZero ? "0" : "1");
  
      measureElements.forEach((measureEl) => {
        measureEl.style.cursor = "pointer";
        measureEl.addEventListener("click", () => {
          const measureId = measureEl.getAttribute("id");
          console.log("Clic en compás con ID:", measureId);
          const parsedNumber = parseInt(measureId.replace(/\D/g, ""), 10);
          const targetMeasure = startsAtZero ? parsedNumber : parsedNumber - 1;
          console.log("Compás mapeado a índice:", targetMeasure);
          
          let foundIndex = scoreEvents.findIndex(ev => ev.measure === targetMeasure);
          if (foundIndex !== -1) {
            currentEventIndex = foundIndex;
            updateCursorPosition(currentEventIndex);
            requestAnimationFrame(performScrollUpdate);
          } else {
            console.warn("No se encontró un evento para el compás con ID:", measureId);
          }
        });
      });
    }
    
    function updateCursorPosition(index) {
      osmd.cursor.reset();
      for (let i = 0; i < index; i++) {
        osmd.cursor.next();
      }
      console.log("Cursor actualizado a índice:", index);
    }
    
    function performScrollUpdate() {
      let cursorEl = osmd.cursor.cursorElement || document.querySelector('.osmd-cursor');
      if (cursorEl) {
        let rect = cursorEl.getBoundingClientRect();
        let cursorCenter = rect.top + rect.height / 2;
        let viewportTarget = window.innerHeight * 0.6;
        let diff = cursorCenter - viewportTarget;
        if (Math.abs(diff) > 20) {
          window.scrollBy({ top: diff, behavior: 'smooth' });
        }
      }
    }
    
    document.getElementById("btnAvanzar").addEventListener("click", () => {
      if (currentEventIndex < scoreEvents.length - 1) {
        currentEventIndex++;
        updateCursorPosition(currentEventIndex);
        requestAnimationFrame(performScrollUpdate);
      } else {
        showFinalMessage();
      }
    });
    
    document.getElementById("btnRetroceder").addEventListener("click", () => {
      if (currentEventIndex > 0) {
        currentEventIndex--;
        updateCursorPosition(currentEventIndex);
        requestAnimationFrame(performScrollUpdate);
      }
    });
    
    function setsEqual(setA, setB) {
      if (setA.size !== setB.size) return false;
      for (let a of setA) {
        if (!setB.has(a)) return false;
      }
      return true;
    }
    
    function setHeaderAndScoreColor(color) {
      document.querySelector("h1").style.color = color;
      document.getElementById("scoreboard").style.backgroundColor = color;
      document.getElementById("score").style.borderColor = color;
      document.getElementById("header").style.borderBottomColor = color;
      document.querySelector(".controls").style.borderBottomColor = color;
    }
    
    function checkUserInput(velocity) {
      if (currentEventIndex >= scoreEvents.length) return;
      let ev = scoreEvents[currentEventIndex];
      let expectedNotes = new Set([...ev.rightHandPitches, ...ev.leftHandPitches]);
      
      if (setsEqual(midiBuffer, expectedNotes)) {
        correctCount++;
        updateScoreboard();
        setHeaderAndScoreColor("green");
      } else {
        errorCount++;
        updateScoreboard();
        setHeaderAndScoreColor("red");
      }
      triggerScoreEvent(velocity);
    }
    
    function updateScoreboard() {
      document.getElementById("scoreboard").textContent = "ACIERTOS: " + correctCount + " | ERRORES: " + errorCount;
    }
    
    function triggerScoreEvent(velocity) {
      if (currentEventIndex >= scoreEvents.length) return;
      let ev = scoreEvents[currentEventIndex];
      let physicalKeys = Array.from(midiBuffer);
      
      if (ev.rightHandPitches.length > 0) {
        activeScoreEvents.push({
          physicalKeys: physicalKeys.slice(),
          scoreNotes: ev.rightHandPitches.slice(),
          hand: "right",
          pendingRelease: false
        });
        let rightHandVelocity = Math.min(127, velocity * 1.1);
        ev.rightHandPitches.forEach(midi => {
          if (midiOutput) midiOutput.send([0x90, midi, rightHandVelocity]);
        });
      }
      if (ev.leftHandPitches.length > 0) {
        activeScoreEvents.push({
          physicalKeys: physicalKeys.slice(),
          scoreNotes: ev.leftHandPitches.slice(),
          hand: "left",
          pendingRelease: false
        });
        ev.leftHandPitches.forEach(midi => {
          if (midiOutput) midiOutput.send([0x90, midi, velocity]);
        });
      }
      osmd.cursor.next();
      console.log("Cursor avanzado vía MIDI.");
      currentEventIndex++;
      requestAnimationFrame(performScrollUpdate);
      midiBuffer.clear();
      if (currentEventIndex >= scoreEvents.length) {
        showFinalMessage();
      }
    }
    
    function showFinalMessage() {
      let total = scoreEvents.length;
      let ratio = total > 0 ? correctCount / total : 0;
      let percentage = Math.floor(ratio * 100);
      let index = percentage >= 100 ? 99 : percentage;
      let phrase = finalPhrases[index];
      let finalDiv = document.getElementById("finalMessage");
      finalDiv.textContent = phrase + " (Aciertos: " + percentage + "%)";
      finalDiv.style.display = "block";
    }
    
    function onMIDISuccess(midiAccess) {
      let foundOutput = false;
      for (let output of midiAccess.outputs.values()) {
        midiOutput = output;
        document.getElementById("midiInfo").innerText = "Dispositivo MIDI: " + output.name;
        updateLocalControl();
        foundOutput = true;
        break;
      }
      if (!foundOutput) {
        document.getElementById("midiInfo").textContent = "Dispositivo MIDI: NO VALIDO";
        document.getElementById("midiInfo").style.color = "red";
      }
      for (let input of midiAccess.inputs.values()) {
        input.onmidimessage = handleMIDIMessage;
      }
    }
    
    function handleMIDIMessage(event) {
      let [command, data1, data2] = event.data;
      let now = performance.now();
      
      if ((command & 0xF0) === 0xB0 && data1 === 64) {
        if (data2 >= 64) {
          sustainPedalActive = true;
          console.log("Pedal de sustain activado.");
        } else {
          sustainPedalActive = false;
          console.log("Pedal de sustain liberado.");
          if (midiOutput) {
            midiOutput.send([0xB0, 64, 0]);
            console.log("Enviando señal de pedal liberado (OFF).");
          }
          activeScoreEvents.forEach(eventObj => {
            if (eventObj.pendingRelease) {
              eventObj.scoreNotes.forEach(scoreNote => {
                if (midiOutput) midiOutput.send([0x80, scoreNote, 0]);
              });
              eventObj.pendingRelease = false;
            }
          });
          activeScoreEvents = activeScoreEvents.filter(evObj => evObj.physicalKeys.length > 0);
        }
        return;
      }
      
      if (command === 0x90 && data2 > 0) {
        midiBuffer.add(data1);
        if (now - lastNoteTime > NOTE_GROUPING_TIME) {
          setTimeout(() => {
            if (midiBuffer.size > 0) {
              checkUserInput(data2);
            }
          }, NOTE_GROUPING_TIME);
        }
        lastNoteTime = now;
      }
      else if (command === 0x80 || (command === 0x90 && data2 === 0)) {
        activeScoreEvents.forEach(eventObj => {
          if (eventObj.physicalKeys.includes(data1)) {
            eventObj.physicalKeys = eventObj.physicalKeys.filter(n => n !== data1);
            if (eventObj.physicalKeys.length === 0) {
              if (sustainPedalActive && eventObj.scoreNotes.includes(data1)) {
                if (midiOutput) {
                  midiOutput.send([0xB0, 64, 127]);
                  console.log("Enviando señal de pedal (ON) para mantener la nota", data1);
                }
              } else {
                if (sustainPedalActive) {
                  eventObj.pendingRelease = true;
                } else {
                  eventObj.scoreNotes.forEach(scoreNote => {
                    if (midiOutput) midiOutput.send([0x80, scoreNote, 0]);
                  });
                }
              }
            }
          }
        });
        activeScoreEvents = activeScoreEvents.filter(evObj => evObj.physicalKeys.length > 0 || evObj.pendingRelease);
      }
    }
    
    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess);
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      fetch("https://cdn.jsdelivr.net/gh/rafgim/NUEVO@main/Red%20Threads%208.musicxml")
        .then(response => response.text())
        .then(musicXML => {
          currentEventIndex = 0;
          loadAndRender(musicXML);
        })
        .catch(error => console.error("Error al cargar la partitura por defecto:", error));
    });
  </script>
</body>
</html>
