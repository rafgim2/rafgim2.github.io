<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DREAM IT by Rafael Gimeno</title>
  <!-- Se incluye JSZip para descomprimir archivos MXL -->
  <script src="https://cdn.jsdelivr.net/npm/webmidiapishim@1.0.7/dist/shim.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@latest/build/opensheetmusicdisplay.min.js"></script>
  <style>
    /* Cabecera fija */
    #header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #add8e6;
      border-bottom: 4px solid #00008B;
      z-index: 1000;
      box-sizing: border-box;
      padding: 10px 20px;
    }
    #header h1 {
      margin: 0;
      font-size: 3em;
      font-family: Segoe UI Black, Haettenschweiler, "Arial Narrow Bold", sans-serif;
      color: #00008B;
      text-align: center;
      line-height: 1.2;
      text-decoration: underline;
    }
    /* Contenedor para cambio de idioma (banderitas) */
    #langSwitcher {
      position: absolute;
      top: 10px;
      right: 20px;
    }
    #langSwitcher button {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 5px;
    }
    /* Se fija el tama√±o de ambas banderitas */
    #langSwitcher img {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }
    /* Ajuste espec√≠fico para la bandera de Espa√±a (achatada) */
    #btn_es img {
      transform: scaleY(0.8);
      transform-origin: center;
    }
    /* Contenedor del bot√≥n de ayuda, ubicado justo debajo de las banderas y alineado a la derecha */
    #helpContainer {
      position: absolute;
      top: 50px;
      right: 20px;
    }
    /* Estilo del bot√≥n de ayuda: redondeado y azul, igual que el resto */
    #btnHelp {
      margin: 5px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-family: sans-serif;
      color: white;
      border-radius: 8px;
      background-color: dodgerblue;
    }
    /* Subcabecera con tres secciones: izquierda, centro y derecha */
    .subheader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 22px;
      position: relative;
    }
    /* Contenedor izquierdo: marcador debajo */
    .left-side {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    /* Contenedor central: "by Rafael Gimeno" centrado */
    .center-side {
      position: absolute;
      margin-top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-family: "Times New Roman", Times, serif;
      font-size: 1em;
      color: #000000;
      text-align: center;
    }
    .center-side a {
      color: inherit;
      text-decoration: none;
    }
    .center-side a:hover {
      text-decoration: underline;
    }
    /* Contenedor derecho: informaci√≥n MIDI */
    .right-side {
      margin-top: 20px;
      font-family: sans-serif;
      font-size: 0.9em;
      color: #000000;
      text-align: right;
    }
    /* Marcador de aciertos y errores */
    #scoreboard {
      padding: 8px 12px;
      background-color: green;
      color: white;
      border: 1px solid #ccc;
      font-family: sans-serif;
      border-radius: 8px;
      font-size: 1em;
    }
    /* Contenedor fijo de controles */
    .controls {
      margin-top: 20px;
      position: fixed;
      top: 120px;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #add8e6;
      border-bottom: 2px solid #00008B;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 900;
      box-sizing: border-box;
    }
    .left-control { position: absolute; left: 20px; }
    .right-control { position: absolute; right: 20px; }
    .middle-control {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #fileLabel {
      padding: 8px 12px;
      background-color: green;
      color: white;
      border: 1px solid #ccc;
      cursor: pointer;
      font-family: sans-serif;
      border-radius: 8px;
    }
    /* Input oculto para archivos */
    #fileInput { display: none; }
    .middle-control button {
      margin: 20px 5px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-family: sans-serif;
      color: white;
      border-radius: 8px;
      background-color: dodgerblue;
    }
    #toggleLocal {
      margin-top: 0px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-family: sans-serif;
      color: white;
      border-radius: 8px;
    }
    /* Estilo para el selector de simultaneidad */
    .middle-control select,
    .middle-control span {
      vertical-align: middle;
      margin: 0 5px;
      font-family: sans-serif;
      font-size: 1em;
    }
    /* Contenedor de la partitura con transformaci√≥n CSS para zoom menor */
    #score {
      border: 4px solid #00008B;
      margin: 200px auto 20px;
      min-height: 600px;
      width: 90%;
      background-color: white;
      transform: scale(0.8);
      transform-origin: top center;
    }
    /* Overlay final centrado en la pantalla */
    #finalMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      font-family: sans-serif;
      font-size: 1.8em;
      text-align: center;
      border: 4px solid #00008B;
      border-radius: 8px;
      z-index: 3000;
      display: none;
    }
    /* Overlay de ayuda centrado en la pantalla */
    #helpOverlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 500px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      font-family: sans-serif;
      font-size: 1.0em;
      text-align: left;
      border: 4px solid #00008B;
      border-radius: 8px;
      z-index: 3000;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Cabecera fija -->
  <div id="header">
    <h1>DREAM IT</h1>
    <!-- Botones de cambio de idioma con im√°genes de banderitas -->
    <div id="langSwitcher">
      <button id="btn_es">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/9/9a/Flag_of_Spain.svg/32px-Flag_of_Spain.svg.png" alt="Espa√±ol">
      </button>
      <button id="btn_en">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/a/ae/Flag_of_the_United_Kingdom.svg/32px-Flag_of_the_United_Kingdom.svg.png" alt="English">
      </button>
    </div>
    <!-- Bot√≥n de ayuda ubicado justo debajo de las banderas -->
    <div id="helpContainer">
      <button id="btnHelp">Ayuda</button>
    </div>
    <div class="subheader">
      <div class="left-side"> 
        <div id="scoreboard">ACIERTOS: 0 | ERRORES: 0</div>
      </div>
      <div class="center-side">
        ¬© <a href="https://www.youtube.com/@rafgim" target="_blank">by Rafael Gimeno</a>
      </div>
      <div class="right-side">
        <div id="midiInfo">Dispositivo MIDI: No detectado</div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor fijo de controles -->
  <div class="controls">
    <div class="left-control">
      <label id="fileLabel" for="fileInput">Elegir archivo .musicxml / .mxl</label>
      <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
    </div>
    <div class="middle-control">
      <button id="btnLeftBoost">M. Izquierda üîä</button>
      <button id="btnRetroceder">‚óÄ</button>
      <span id="simultaneityLabel">Intervalo de simultaneidad (ms):</span>
      <select id="simultaneitySelector">
        <option value="25">&lt; 25 ms</option>
        <option value="50" selected>&lt; 50 ms</option>
        <option value="75">&lt; 75 ms</option>
        <option value="100">&lt; 100 ms</option>
      </select>
      <button id="btnAvanzar">‚ñ∂</button>
      <button id="btnRightBoost">M. Derecha üîä</button>
    </div>
    <div class="right-control">
      <button id="toggleLocal">Local Control: OFF</button>
    </div>
  </div>
  
  <!-- Contenedor de la partitura -->
  <div id="score"></div>
  
  <!-- Overlay para el mensaje final -->
  <div id="finalMessage"></div>
  <!-- Overlay para la ayuda -->
  <div id="helpOverlay"></div>
  
  <script>
    // Variables globales para traducci√≥n y control del juego
    let currentLanguage = 'es'; // 'es' para espa√±ol, 'en' para ingl√©s
    let gameEnded = false; // Indica si ya se mostr√≥ la frase final

    // Variable para el intervalo de simultaneidad (en ms)
    let noteGroupingTime = 50;
    
    // Variable para seleccionar la mano que se refuerza (por defecto "right")
    let boostHand = "right";
    
    const translations = {
      es: {
        scoreboard: (correct, error) => `ACIERTOS: ${correct} | ERRORES: ${error}`,
        fileLabel: "Elegir archivo",
        btnRetroceder: "‚óÄ",
        btnAvanzar: "‚ñ∂",
        btnLeftBoost: "M. Izquierda üîä",
        btnRightBoost: "M. Derecha üîä",
        toggleLocal_off: "Local Control: OFF",
        toggleLocal_on: "Local Control: ON",
        midiInfo_noDetected: "Dispositivo MIDI: No detectado",
        midiInfo_notValid: "Dispositivo MIDI: NO VALIDO",
        finalSuffix: (percentage) => ` (Aciertos: ${percentage}%)`,
        simultaneityLabel: "Teclas simult√°neas (ms):",
        btnHelp: "Ayuda"
      },
      en: {
        scoreboard: (correct, error) => `HITS: ${correct} | ERRORS: ${error}`,
        fileLabel: "Choose file",
        btnRetroceder: "‚óÄ",
        btnAvanzar: "‚ñ∂",
        btnLeftBoost: "L. Hand üîä",
        btnRightBoost: "R. Hand üîä",
        toggleLocal_off: "Local Control: OFF",
        toggleLocal_on: "Local Control: ON",
        midiInfo_noDetected: "MIDI Device: Not detected",
        midiInfo_notValid: "MIDI Device: NOT VALID",
        finalSuffix: (percentage) => ` (Hits: ${percentage}%)`,
        simultaneityLabel: "Simultaneous keys (ms):",
        btnHelp: "Help"
      }
    };

    const finalPhrases_es = [
      "¬°Vaya, hoy las notas decidieron jugar al escondite!",
      "¬°Ups! Parece que el comp√°s se te escap√≥ hoy.",
      "¬°No te preocupes! Hasta los grandes tienen d√≠as sin ritmo.",
      "¬°Epa! La partitura se puso de mal humor contigo.",
      "¬°Casi! Pero parece que las teclas se tomaron un descansito.",
      "¬°Tranquilo! Cada error es un paso hacia la mejora.",
      "¬°Buen intento! Las notas siguen esperando su turno.",
      "¬°Ouch! No fue tu mejor d√≠a musical, pero r√≠ete de ello.",
      "¬°Jaja! La sinfon√≠a se ri√≥ un poco de tus fallos.",
      "¬°Vaya, qu√© curioso! Hoy el comp√°s jug√≥ en tu contra.",
      "¬°√Ånimo! Cada error es solo un preludio a la grandeza.",
      "¬°Qu√© divertido! Pareces improvisar con chispa.",
      "¬°Sigue intent√°ndolo! Hoy las notas est√°n de broma.",
      "¬°Interesante! Tus errores tienen su propio ritmo.",
      "¬°Ja! La partitura tiene un sentido del humor especial contigo.",
      "¬°Eso fue inesperado! Quiz√° las teclas se tomaron un recreo.",
      "¬°R√≠e y sigue! La m√∫sica es una aventura, no una competencia.",
      "¬°Carcajadas! Parece que las notas se divirtieron a tu costa.",
      "¬°Venga, a re√≠r! Cada fallo es una an√©cdota musical.",
      "¬°No te rindas! Incluso los maestros tuvieron d√≠as as√≠.",
      "¬°Oye! Tus errores tienen estilo, ¬°sigue adelante!",
      "¬°Fant√°stico! Aunque fallaste, al menos lo hiciste con gracia.",
      "¬°Qu√© original! Tu interpretaci√≥n tiene un toque √∫nico.",
      "¬°Esos compases son toda una comedia musical!",
      "¬°De risa! Cada error es un chiste bien contado.",
      "¬°No te lo tomes tan en serio! La m√∫sica tambi√©n es diversi√≥n.",
      "¬°Vamos, sigue practicando! Cada fallo es una oportunidad en potencia.",
      "¬°Qu√© show! Tus errores casi forman parte del espect√°culo.",
      "¬°Lo hiciste a tu manera! Un poco de improvisaci√≥n nunca est√° de m√°s.",
      "¬°R√≠e y sigue! Hoy las notas decidieron tomarse un recreo.",
      "¬°Nada mal! Tus errores hacen que la partitura sea m√°s entretenida.",
      "¬°Un d√≠a peculiar! Las teclas se pusieron creativas hoy.",
      "¬°Divertido intento! La m√∫sica sabe re√≠rse contigo.",
      "¬°Sigue adelante! Cada error es una oportunidad para mejorar.",
      "¬°Bien, casi lo tienes! La improvisaci√≥n es un arte.",
      "¬°Eso fue inesperado! Las notas tienen sentido del humor.",
      "¬°Vaya, qu√© ocurrencia! Tus errores son dignos de una an√©cdota.",
      "¬°Rel√°jate! La partitura tiene d√≠as de humor variable.",
      "¬°Menos mal que es solo m√∫sica! R√≠ete de ti mismo.",
      "¬°Qu√© gracioso! Tus notas crean una historia divertida.",
      "¬°Int√©ntalo de nuevo! Cada fallo es una risa en la historia musical.",
      "¬°Oye, no pasa nada! Hasta los grandes tienen d√≠as raros.",
      "¬°Bien ah√≠! La risa es el mejor acompa√±ante del error.",
      "¬°Un paso en falso, pero con estilo!",
      "¬°A re√≠r se ha dicho! La m√∫sica te invita a disfrutar.",
      "¬°Esa fue una jugada inesperada! La partitura se qued√≥ de piedra.",
      "¬°No te lo tomes a pecho! Cada fallo es parte de tu comedia personal.",
      "¬°Jaja, qu√© ocurrencia! Las teclas te hicieron una broma hoy.",
      "¬°Bien, casi lo tienes! Los errores son parte del show.",
      "¬°Una interpretaci√≥n √∫nica! Aunque no aciertes, se nota tu estilo.",
      "¬°Sigue practicando! Los errores te hacen m√°s humano.",
      "¬°De lo m√°s divertido! Tus fallos tienen su propia melod√≠a.",
      "¬°R√≠e y mejora! La m√∫sica es un viaje lleno de sorpresas.",
      "¬°No te lo tomes a pecho! Cada fallo es parte de la sinfon√≠a de la vida.",
      "¬°Una aventura musical! Tus errores son casi intencionales.",
      "¬°Un toque de humor en cada comp√°s, sigue as√≠!",
      "¬°Sigue intent√°ndolo! Incluso los errores pueden sonar bien.",
      "¬°Inesperado y divertido! Tus notas crean momentos √∫nicos.",
      "¬°No te detengas! Cada fallo te acerca a un gran acierto.",
      "¬°Un poco de improvisaci√≥n nunca est√° de m√°s!",
      "¬°Lo hiciste con gracia, aunque no fuera perfecto!",
      "¬°Divertido intento! La m√∫sica es un juego, r√≠ete de los tropiezos.",
      "¬°Nada mal! A veces los errores son la mejor parte de la actuaci√≥n.",
      "¬°Sigue practicando! Los mejores m√∫sicos tambi√©n tienen tropiezos.",
      "¬°Con humor se avanza! Cada nota fallida es una broma musical.",
      "¬°A re√≠r se ha dicho! La partitura aprecia tu autenticidad.",
      "¬°Qu√© simp√°tico! Aunque no aciertes, lo haces con estilo.",
      "¬°Pura improvisaci√≥n! Tus errores son parte del encanto.",
      "¬°R√≠e y sigue! La m√∫sica te sonr√≠e, incluso en los tropiezos.",
      "¬°Menos mal que es solo m√∫sica! Cada error te ense√±a algo nuevo.",
      "¬°Sigue adelante! La risa es la mejor respuesta a un fallo.",
      "¬°Bien jugado! Tus errores hacen la actuaci√≥n memorable.",
      "¬°No pasa nada! Cada comp√°s fallido es una an√©cdota divertida.",
      "¬°Divertido y √∫nico! Tu interpretaci√≥n es irrepetible.",
      "¬°R√≠e, que la m√∫sica es para disfrutar, errores incluidos!",
      "¬°Con humor se aprende! Cada error es un paso hacia el √©xito.",
      "¬°Un toque c√≥mico en cada nota, sigue practicando!",
      "¬°Muy gracioso! La sinfon√≠a aprecia tu sinceridad musical.",
      "¬°Sigue intent√°ndolo! Incluso los errores tienen su encanto.",
      "¬°Una interpretaci√≥n memorable! Tus fallos son parte del viaje.",
      "¬°Con cada comp√°s, te acercas a la perfecci√≥n ‚Äì r√≠e de los errores!",
      "¬°No te rindas! La m√∫sica es un juego y cada error es diversi√≥n.",
      "¬°Sigue adelante con humor! Cada nota fallida es una an√©cdota.",
      "¬°Una risa en cada comp√°s, sigue mejorando!",
      "¬°Qu√© divertido! La partitura se alegra con cada intento.",
      "¬°Tus errores tienen su propio ritmo, y eso es genial!",
      "¬°La risa es parte del arte! Sigue tocando y aprendiendo.",
      "¬°Contin√∫a en el camino! Cada error te hace √∫nico y divertido.",
      "¬°No te detengas! La m√∫sica es una comedia de la vida, sigue adelante!",
      "¬°Una lecci√≥n en cada comp√°s, y la risa nunca falta!",
      "¬°Fabuloso! Con m√°s del 90‚ÄØ% de aciertos, ¬°eres un prodigio musical!",
      "¬°Incre√≠ble! M√°s del 90‚ÄØ% de aciertos; la orquesta te aclama.",
      "¬°Excepcional! Tu precisi√≥n supera el 90‚ÄØ%, ¬°enhorabuena de verdad!",
      "¬°Magn√≠fico! Con m√°s del 90‚ÄØ% de aciertos, la sinfon√≠a brilla para ti.",
      "¬°Estelar! Superaste el 90‚ÄØ%; ¬°tu talento es innegable!",
      "¬°Sobresaliente! M√°s del 90‚ÄØ% de aciertos; ¬°eres una leyenda musical!",
      "¬°Impecable! Con m√°s del 90‚ÄØ% de aciertos, la m√∫sica te rinde homenaje.",
      "¬°Perfecto! M√°s del 90‚ÄØ% de aciertos; ¬°has alcanzado la perfecci√≥n musical!",
      "¬°De otro mundo! Con m√°s del 90‚ÄØ% de aciertos, ¬°la sinfon√≠a se rinde ante ti!",
      "¬°Monumental! Has logrado un 100‚ÄØ% de aciertos; ¬°eres insuperable!",
      "¬°Legendario! Con un 100‚ÄØ% de aciertos, tu talento trasciende la m√∫sica."
    ];
    
    const finalPhrases_en = [
      "Wow, today the notes decided to play hide and seek!",
      "Oops! It seems the beat slipped away from you today.",
      "Don't worry! Even the greats have off days.",
      "Whoa! The sheet music got in a bad mood with you.",
      "Almost! But it seems the keys took a little break.",
      "Calm down! Every mistake is a step towards improvement.",
      "Good try! The notes are still waiting for their turn.",
      "Ouch! It wasn't your best musical day, but laugh it off.",
      "Haha! The symphony laughed a little at your mistakes.",
      "Wow, how curious! Today the beat was against you.",
      "Cheer up! Every mistake is just a prelude to greatness.",
      "How fun! You seem to be improvising with flair.",
      "Keep trying! Today the notes are just in a playful mood.",
      "Interesting! Your mistakes have their own rhythm.",
      "Ha! The sheet music has a special sense of humor with you.",
      "That was unexpected! Perhaps the keys took a little break.",
      "Laugh and carry on! Music is an adventure, not a competition.",
      "Laughter! It seems the notes had fun at your expense.",
      "Come on, laugh it off! Every mistake is a musical anecdote.",
      "Don't give up! Even the masters have days like this.",
      "Hey! Your mistakes have style, keep going!",
      "Fantastic! Even though you missed, at least you did it with grace.",
      "How original! Your performance has a unique touch.",
      "Those measures are a complete musical comedy!",
      "Hilarious! Every mistake is a well-told joke.",
      "Don't take it so seriously! Music is also about fun.",
      "Come on, keep practicing! Every mistake is a hidden opportunity.",
      "What a show! Your mistakes almost became part of the performance.",
      "You did it your own way! A bit of improvisation never hurts.",
      "Laugh and carry on! Today the notes decided to take a break.",
      "Not bad! Your mistakes make the sheet music more entertaining.",
      "What a peculiar day! The keys got creative today.",
      "Funny attempt! Music knows how to laugh along with you.",
      "Keep going! Every mistake is an opportunity to improve.",
      "Good, you're almost there! Improvisation is an art.",
      "That was unexpected! The notes have a sense of humor.",
      "Wow, what a moment! Your mistakes are anecdote-worthy.",
      "Relax! The sheet music has days of variable humor.",
      "Thank goodness it's just music! Laugh at yourself.",
      "How funny! Your notes create a fun story.",
      "Try again! Every mistake is a laugh in the history of music.",
      "Hey, it's okay! Even the greats have odd days.",
      "Well done! Laughter is the best companion to a mistake.",
      "A misstep, but with style!",
      "Let's laugh then! Music invites you to enjoy.",
      "That was an unexpected move! The sheet music was left speechless.",
      "Don't take it to heart! Every mistake is part of your personal comedy.",
      "Haha, what a quirk! The keys played a joke on you today.",
      "Well, you're almost there! Mistakes are part of the show.",
      "A unique performance! Even if you miss, your style shines through.",
      "Keep practicing! Mistakes make you more human.",
      "So funny! Your mistakes have their own melody.",
      "Laugh and improve! Music is a journey full of surprises.",
      "Don't take it to heart! Every mistake is part of life's symphony.",
      "A musical adventure! Your mistakes are almost intentional.",
      "A touch of humor in every measure, keep it up!",
      "Keep trying! Even mistakes can sound good.",
      "Unexpected and fun! Your notes create unique moments.",
      "Don't stop! Every mistake brings you closer to a big success.",
      "A little improvisation never hurts!",
      "You did it with grace, even if it wasn't perfect!",
      "Funny attempt! Music is a game, laugh at the stumbles.",
      "Not bad! Sometimes mistakes are the best part of the performance.",
      "Keep practicing! Even the best musicians have missteps.",
      "With humor, you move forward! Every missed note is a musical joke.",
      "Let's laugh then! The sheet music appreciates your authenticity.",
      "How charming! Even if you don't hit the mark, you do it with style.",
      "Pure improvisation! Your mistakes are part of the charm.",
      "Laugh and carry on! Music smiles at you, even in the stumbles.",
      "Thank goodness it's just music! Every mistake teaches you something new.",
      "Keep going! Laughter is the best response to a mistake.",
      "Well played! Your mistakes make the performance memorable.",
      "It's okay! Every missed measure is a fun anecdote.",
      "Fun and unique! Your performance is one-of-a-kind.",
      "Laugh, because music is for enjoying‚Äîeven mistakes included!",
      "You learn with humor! Every mistake is a step towards success.",
      "A comedic touch in every note, keep practicing!",
      "Very funny! The symphony appreciates your musical sincerity.",
      "Keep trying! Even mistakes have their own charm.",
      "A memorable performance! Your mistakes are part of the journey.",
      "With every measure, you're closer to perfection ‚Äì laugh at the mistakes!",
      "Don't give up! Music is a game and every mistake is fun.",
      "Keep moving forward with humor! Every missed note is an anecdote.",
      "A laugh in every measure, keep improving!",
      "How fun! The sheet music cheers with every attempt.",
      "Your mistakes have their own rhythm, and that's awesome!",
      "Laughter is part of the art! Keep playing and learning.",
      "Keep on the path! Every mistake makes you unique and fun.",
      "Don't stop! Music is a comedy of life, keep going!",
      "A lesson in every measure, and laughter is never in short supply!",
      "Fabulous! With over 90% hits, you're a musical prodigy!",
      "Incredible! Over 90% hits; the orchestra applauds you.",
      "Exceptional! Your accuracy exceeds 90%, truly congratulations!",
      "Magnificent! With over 90% hits, the symphony shines for you.",
      "Stellar! You surpassed 90%; your talent is undeniable!",
      "Outstanding! With over 90% hits; you're a musical legend!",
      "Impeccable! With over 90% hits, music pays homage to you.",
      "Perfect! With over 90% hits; you've achieved musical perfection!",
      "Out of this world! With over 90% hits, the symphony bows down to you!",
      "Monumental! You've achieved 100% hits; you're unbeatable!",
      "Legendary! With 100% hits, your talent transcends music."
    ];

    // Inicializaci√≥n de OSMD y otras variables
    let osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", { drawingParameters: "default" });
    let scoreEvents = [];
    let currentEventIndex = 0;
    let midiOutput = null;
    let activeTiedNotes = new Set();
    let midiBuffer = new Set();
    let lastNoteTime = 0;
    
    let sustainPedalActive = false;
    let activeScoreEvents = [];
    let localControlEnabled = false;
    
    let correctCount = 0;
    let errorCount = 0;
    
    updateLanguage();
    
    function updateLanguage() {
      const lang = translations[currentLanguage];
      
      // Actualiza textos de botones y etiquetas
      document.getElementById("scoreboard").textContent = lang.scoreboard(correctCount, errorCount);
      document.getElementById("fileLabel").textContent = lang.fileLabel;
      document.getElementById("btnRetroceder").textContent = lang.btnRetroceder;
      document.getElementById("btnAvanzar").textContent = lang.btnAvanzar;
      document.getElementById("toggleLocal").textContent = localControlEnabled ? lang.toggleLocal_on : lang.toggleLocal_off;
      document.getElementById("simultaneityLabel").textContent = lang.simultaneityLabel;
      document.getElementById("btnLeftBoost").textContent = lang.btnLeftBoost;
      document.getElementById("btnRightBoost").textContent = lang.btnRightBoost;
      document.getElementById("btnHelp").textContent = lang.btnHelp;
      
      const midiInfo = document.getElementById("midiInfo");
      if (midiOutput) {
        midiInfo.textContent = lang.midiInfo_noDetected.replace(currentLanguage === 'es' ? "No detectado" : "Not detected", midiOutput.name);
      } else {
        midiInfo.textContent = lang.midiInfo_noDetected;
      }
      
      // Actualiza el mensaje final si se est√° mostrando
      const finalDiv = document.getElementById("finalMessage");
      if (finalDiv.style.display !== "none") {
        let total = scoreEvents.length;
        let ratio = total > 0 ? correctCount / total : 0;
        let percentage = Math.floor(ratio * 100);
        let index = percentage >= 100 ? 99 : percentage;
        let phrases = currentLanguage === 'en' ? finalPhrases_en : finalPhrases_es;
        let phrase = phrases[index];
        finalDiv.textContent = phrase + lang.finalSuffix(percentage);
      }
      
      // Actualiza el texto del overlay de ayuda si est√° visible
      const helpOverlay = document.getElementById("helpOverlay");
      if (helpOverlay.style.display !== "none" && helpOverlay.style.display !== "") {
        if (currentLanguage === "en") {
          helpOverlay.innerHTML = "DREAM IT is an app that allows you to play without mistakes by correcting errors in real-time, recording your hits and misses while maintaining your original dynamics. Here is the functionality of the main buttons:<br><br> - Choose file: select a .musicxml, .mxl, or .xml file. <br> - Hand buttons: increase the volume of the selected hand by 10%. <br> - Forward and Back: move forward or backward one space in the score. <br> - MIDI Local Control: turn the piano's local control on or off. <br> - Flag buttons: translate the texts to the corresponding language.<br> - Simultaneity selector: threshold in milliseconds at which the app recognizes keys that should sound together, generating a single displacement in the score.";
        } else {
          helpOverlay.innerHTML = "DREAM IT, es una app que permite tocar sin errores corrigiendo en tiempo real cualquier error, registrando tus aciertos y fallos y manteniendo tu din√°mica original. Aqu√≠ tienes la funcionalidad de los botones principales:<br><br> - Elegir archivo: elige un archivo .musicxml, .mxl o .xml. <br> - Botones de manos: incrementa el volumen un 10% la mano seleccionada. <br> - Avanzar y retroceder: avanza o retrocede un espacio en la partitura. <br> - Midi Local Control: enciende o apaga el control local del piano. <br> - Botones de banderas: traduce los textos al idioma correspondiente.<br> - Selector de simultaneidad: umbral en milisegundos en el que la app reconoce teclas que deben sonar juntas, generando un solo desplazamiento en la partitura.";
        }
      }
    }
    
    // Listener para cambio de idioma
    document.getElementById("btn_es").addEventListener("click", function() {
      currentLanguage = 'es';
      updateLanguage();
    });
    
    document.getElementById("btn_en").addEventListener("click", function() {
      currentLanguage = 'en';
      updateLanguage();
    });
    
    // Listener para el selector de simultaneidad
    document.getElementById("simultaneitySelector").addEventListener("change", function(e) {
      noteGroupingTime = parseInt(e.target.value);
      console.log("Nuevo intervalo de simultaneidad:", noteGroupingTime, "ms");
    });
    
    // Actualiza el bot√≥n de control MIDI local
    function updateLocalControl() {
      const btn = document.getElementById("toggleLocal");
      const lang = translations[currentLanguage];
      if (localControlEnabled) {
        btn.textContent = lang.toggleLocal_on;
        btn.style.backgroundColor = "green";
        if (midiOutput) {
          try {
            midiOutput.send([0xB0, 122, 127]);
          } catch (err) {
            console.error("Error enviando mensaje MIDI para activar control local:", err);
            document.getElementById("midiInfo").textContent = lang.midiInfo_notValid;
            document.getElementById("midiInfo").style.color = "red";
          }
        }
      } else {
        btn.textContent = lang.toggleLocal_off;
        btn.style.backgroundColor = "red";
        if (midiOutput) {
          try {
            midiOutput.send([0xB0, 122, 0]);
          } catch (err) {
            console.error("Error enviando mensaje MIDI para desactivar control local:", err);
            document.getElementById("midiInfo").textContent = lang.midiInfo_notValid;
            document.getElementById("midiInfo").style.color = "red";
          }
        }
      }
    }
    
    document.getElementById("toggleLocal").addEventListener("click", function() {
      localControlEnabled = !localControlEnabled;
      updateLocalControl();
    });
    updateLocalControl();
    
    // Listeners para los botones de boost de mano
    document.getElementById("btnLeftBoost").addEventListener("click", () => {
      boostHand = "left";
      document.getElementById("btnLeftBoost").style.backgroundColor = "green";
      document.getElementById("btnRightBoost").style.backgroundColor = "dodgerblue";
      console.log("Boost activado para la mano izquierda.");
    });
    
    document.getElementById("btnRightBoost").addEventListener("click", () => {
      boostHand = "right";
      document.getElementById("btnRightBoost").style.backgroundColor = "green";
      document.getElementById("btnLeftBoost").style.backgroundColor = "dodgerblue";
      console.log("Boost activado para la mano derecha.");
    });
    // Por defecto, la mano derecha ya tiene el boost (bot√≥n en verde)
    document.getElementById("btnRightBoost").style.backgroundColor = "green";
    
    // Listener para el bot√≥n de ayuda que muestra/oculta la ayuda
    document.getElementById("btnHelp").addEventListener("click", () => {
      const helpOverlay = document.getElementById("helpOverlay");
      const btnHelp = document.getElementById("btnHelp");
      if (helpOverlay.style.display === "none" || helpOverlay.style.display === "") {
          if (currentLanguage === "en") {
              helpOverlay.innerHTML = "DREAM IT is an app that allows you to play without mistakes by correcting errors in real-time, recording your hits and misses while maintaining your original dynamics. Here is the functionality of the main buttons:<br><br> - Choose file: select a .musicxml, .mxl, or .xml file. <br> - Hand buttons: increase the volume of the selected hand by 10%. <br> - Forward and Back: move forward or backward one space in the score. <br> - MIDI Local Control: turn the piano's local control on or off. <br> - Flag buttons: translate the texts to the corresponding language.<br> - Simultaneity selector: threshold in milliseconds at which the app recognizes keys that should sound together, generating a single displacement in the score.";
          } else {
              helpOverlay.innerHTML = "DREAM IT, es una app que permite tocar sin errores corrigiendo en tiempo real cualquier error, registrando tus aciertos y fallos y manteniendo tu din√°mica original. Aqu√≠ tienes la funcionalidad de los botones principales:<br><br> - Elegir archivo: elige un archivo .musicxml, .mxl o .xml. <br> - Botones de manos: incrementa el volumen un 10% la mano seleccionada. <br> - Avanzar y retroceder: avanza o retrocede un espacio en la partitura. <br> - Midi Local Control: enciende o apaga el control local del piano. <br> - Botones de banderas: traduce los textos al idioma correspondiente.<br> - Selector de simultaneidad: umbral en milisegundos en el que la app reconoce teclas que deben sonar juntas, generando un solo desplazamiento en la partitura.";
          }
          helpOverlay.style.display = "block";
          btnHelp.style.backgroundColor = "green";
      } else {
          helpOverlay.style.display = "none";
          btnHelp.style.backgroundColor = "dodgerblue";
      }
    });
    
    async function loadAndRender(musicXML) {
      document.getElementById("finalMessage").style.display = "none";
      resetState();
      gameEnded = false;
      try {
        console.log("Cargando MusicXML...");
        await osmd.load(musicXML);
        osmd.render();
        console.log("Partitura renderizada correctamente.");
        osmd.cursor.reset();
        osmd.cursor.show();
        setTimeout(() => {
          console.log("Extrayendo eventos...");
          extractScoreEvents();
          addMeasureClickListeners();
          if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess);
          }
        }, 1000);
      } catch (error) {
        console.error("Error al cargar/renderizar el MusicXML:", error);
      }
    }
    
    document.getElementById("fileInput").addEventListener("change", function(e) {
      let file = e.target.files[0];
      if (!file) return;
      const fileName = file.name.toLowerCase();
      if (fileName.endsWith(".mxl")) {
        console.log("Archivo MXL detectado.");
        let reader = new FileReader();
        reader.onload = function(e) {
          JSZip.loadAsync(e.target.result)
            .then(zip => {
              console.log("Archivo MXL descomprimido. Archivos encontrados:", Object.keys(zip.files));
              if(zip.files["META-INF/container.xml"]) {
                return zip.file("META-INF/container.xml").async("string")
                  .then(containerXML => {
                    console.log("container.xml le√≠do:", containerXML.substring(0,200));
                    let parser = new DOMParser();
                    let xmlDoc = parser.parseFromString(containerXML, "application/xml");
                    let rootfileElement = xmlDoc.querySelector("rootfile");
                    if(rootfileElement) {
                      let fullPath = rootfileElement.getAttribute("full-path");
                      console.log("Archivo principal indicado en container.xml:", fullPath);
                      return zip.file(fullPath).async("string");
                    } else {
                      console.error("No se encontr√≥ elemento rootfile en container.xml");
                      throw new Error("No se encontr√≥ elemento rootfile en container.xml");
                    }
                  });
              } else {
                let xmlFile = null;
                for (let filename in zip.files) {
                  if (filename.toLowerCase().endsWith(".xml") || filename.toLowerCase().endsWith(".musicxml")) {
                    xmlFile = filename;
                    break;
                  }
                }
                if (xmlFile) {
                  console.log("Archivo XML encontrado en el MXL:", xmlFile);
                  return zip.file(xmlFile).async("string");
                } else {
                  throw new Error("No se encontr√≥ ning√∫n archivo XML dentro del MXL.");
                }
              }
            })
            .then(musicXML => {
              currentEventIndex = 0;
              loadAndRender(musicXML);
              document.getElementById("fileInput").value = "";
            })
            .catch(err => {
              console.error("Error al descomprimir el archivo MXL:", err);
            });
        };
        reader.readAsArrayBuffer(file);
      } else {
        let reader = new FileReader();
        reader.onload = function(e) {
          let musicXML = e.target.result;
          currentEventIndex = 0;
          loadAndRender(musicXML);
          document.getElementById("fileInput").value = "";
        };
        reader.readAsText(file);
      }
    });
    
    function extractScoreEvents() {
      scoreEvents = [];
      if (!osmd.sheet || !osmd.sheet.sourceMeasures || osmd.sheet.sourceMeasures.length === 0) {
        console.warn("No se encontraron compases en osmd.sheet.");
        return;
      }
      osmd.sheet.sourceMeasures.forEach((measure, mIndex) => {
        measure.verticalSourceStaffEntryContainers.forEach((verticalEntry) => {
          let rightHandPitches = [];
          let leftHandPitches = [];
          verticalEntry.staffEntries.forEach((staffEntry, staffIndex) => {
            staffEntry.voiceEntries.forEach(ve => {
              ve.notes.forEach(note => {
                let midi = getMidiPitch(note);
                if (midi !== undefined) {
                  let isTied = note.NoteTie;
                  if (isTied) {
                    if (activeTiedNotes.has(midi)) {
                      activeTiedNotes.delete(midi);
                    } else {
                      activeTiedNotes.add(midi);
                      (staffIndex === 0 ? rightHandPitches : leftHandPitches).push(midi);
                    }
                  } else {
                    (staffIndex === 0 ? rightHandPitches : leftHandPitches).push(midi);
                  }
                }
              });
            });
          });
          if (rightHandPitches.length > 0 || leftHandPitches.length > 0) {
            scoreEvents.push({ measure: mIndex, rightHandPitches, leftHandPitches });
          }
        });
      });
      console.log("scoreEvents:", scoreEvents);
    }
    
    function getMidiPitch(note) {
      return note.pitch && note.pitch.halfTone !== undefined ? note.pitch.halfTone + 12 : undefined;
    }
    
    function addMeasureClickListeners() {
      const measureElements = document.querySelectorAll("g.vf-measure[id]");
      console.log("Encontrados", measureElements.length, "compases con 'id'.");
      
      const measureNumbers = Array.from(measureElements).map(me =>
        parseInt(me.getAttribute("id").replace(/\D/g, ""), 10)
      );
      const startsAtZero = Math.min(...measureNumbers) === 0;
      console.log("Los n√∫meros de comp√°s empiezan en", startsAtZero ? "0" : "1");
  
      measureElements.forEach((measureEl) => {
        measureEl.style.cursor = "pointer";
        measureEl.addEventListener("click", () => {
          if (gameEnded) return;
          const measureId = measureEl.getAttribute("id");
          console.log("Clic en comp√°s con ID:", measureId);
          const parsedNumber = parseInt(measureId.replace(/\D/g, ""), 10);
          const targetMeasure = startsAtZero ? parsedNumber : parsedNumber - 1;
          console.log("Comp√°s mapeado a √≠ndice:", targetMeasure);
          
          let foundIndex = scoreEvents.findIndex(ev => ev.measure === targetMeasure);
          if (foundIndex !== -1) {
            currentEventIndex = foundIndex;
            updateCursorPosition(currentEventIndex);
            requestAnimationFrame(performScrollUpdate);
          } else {
            console.warn("No se encontr√≥ un evento para el comp√°s con ID:", measureId);
          }
        });
      });
    }
    
    function updateCursorPosition(index) {
      osmd.cursor.reset();
      for (let i = 0; i < index; i++) {
        osmd.cursor.next();
      }
      console.log("Cursor actualizado a √≠ndice:", index);
    }
    
    function performScrollUpdate() {
      let cursorEl = osmd.cursor.cursorElement || document.querySelector('.osmd-cursor');
      if (cursorEl) {
        let rect = cursorEl.getBoundingClientRect();
        let cursorCenter = rect.top + rect.height / 2;
        let viewportTarget = window.innerHeight * 0.5;
        let diff = cursorCenter - viewportTarget;
        if (Math.abs(diff) > 20) {
          window.scrollBy({ top: diff, behavior: 'smooth' });
        }
      }
    }
    
    document.getElementById("btnAvanzar").addEventListener("click", () => {
      if (gameEnded) return;
      if (currentEventIndex < scoreEvents.length - 1) {
        currentEventIndex++;
        updateCursorPosition(currentEventIndex);
        requestAnimationFrame(performScrollUpdate);
      } else {
        showFinalMessage();
      }
    });
    
    document.getElementById("btnRetroceder").addEventListener("click", () => {
      if (gameEnded) return;
      if (currentEventIndex > 0) {
        currentEventIndex--;
        updateCursorPosition(currentEventIndex);
        requestAnimationFrame(performScrollUpdate);
      }
    });
    
    // Se ha modificado la funci√≥n para aplicar el boost solo a la mano seleccionada
    function triggerScoreEvent(velocity) {
      if (currentEventIndex >= scoreEvents.length) return;
      let ev = scoreEvents[currentEventIndex];
      let physicalKeys = Array.from(midiBuffer);
      
      // Notas de la mano derecha
      if (ev.rightHandPitches.length > 0) {
        activeScoreEvents.push({
          physicalKeys: physicalKeys.slice(),
          scoreNotes: ev.rightHandPitches.slice(),
          hand: "right",
          pendingRelease: false
        });
        let adjustedVelocity = boostHand === "right" ? Math.min(127, velocity * 1.1) : velocity;
        ev.rightHandPitches.forEach(midi => {
          if (midiOutput) midiOutput.send([0x90, midi, adjustedVelocity]);
        });
      }
      // Notas de la mano izquierda
      if (ev.leftHandPitches.length > 0) {
        activeScoreEvents.push({
          physicalKeys: physicalKeys.slice(),
          scoreNotes: ev.leftHandPitches.slice(),
          hand: "left",
          pendingRelease: false
        });
        let adjustedVelocity = boostHand === "left" ? Math.min(127, velocity * 1.1) : velocity;
        ev.leftHandPitches.forEach(midi => {
          if (midiOutput) midiOutput.send([0x90, midi, adjustedVelocity]);
        });
      }
      osmd.cursor.next();
      console.log("Cursor avanzado v√≠a MIDI.");
      currentEventIndex++;
      requestAnimationFrame(performScrollUpdate);
      midiBuffer.clear();
      if (currentEventIndex >= scoreEvents.length) {
        showFinalMessage();
      }
    }
    
    function updateScoreboard() {
      const lang = translations[currentLanguage];
      document.getElementById("scoreboard").textContent = lang.scoreboard(correctCount, errorCount);
    }
    
    function checkUserInput(velocity) {
      if (currentEventIndex >= scoreEvents.length) return;
      let ev = scoreEvents[currentEventIndex];
      let expectedNotes = new Set([...ev.rightHandPitches, ...ev.leftHandPitches]);
      
      if (setsEqual(midiBuffer, expectedNotes)) {
        correctCount++;
        updateScoreboard();
        setHeaderAndScoreColor("green");
      } else {
        errorCount++;
        updateScoreboard();
        setHeaderAndScoreColor("red");
      }
      triggerScoreEvent(velocity);
    }
    
    function setsEqual(setA, setB) {
      if (setA.size !== setB.size) return false;
      for (let a of setA) {
        if (!setB.has(a)) return false;
      }
      return true;
    }
    
    function setHeaderAndScoreColor(color) {
      document.querySelector("h1").style.color = color;
      document.getElementById("scoreboard").style.backgroundColor = color;
      document.getElementById("score").style.borderColor = color;
      document.getElementById("score").style.backgroundColor = "white";
      document.body.style.backgroundColor = color === "green" ? "#ccffcc" : "#ffcccc";
      document.getElementById("header").style.borderBottomColor = color;
      document.querySelector(".controls").style.borderBottomColor = color;
    }
    
    function showFinalMessage() {
      let total = scoreEvents.length;
      let ratio = total > 0 ? correctCount / total : 0;
      let percentage = Math.floor(ratio * 100);
      let index = percentage >= 100 ? 99 : percentage;
      let phrases = currentLanguage === 'en' ? finalPhrases_en : finalPhrases_es;
      let phrase = phrases[index];
      let finalDiv = document.getElementById("finalMessage");
      finalDiv.textContent = phrase + translations[currentLanguage].finalSuffix(percentage);
      finalDiv.style.display = "block";
      gameEnded = true;
    }
    
    function onMIDISuccess(midiAccess) {
      let foundOutput = false;
      for (let output of midiAccess.outputs.values()) {
        midiOutput = output;
        document.getElementById("midiInfo").innerText =
          translations[currentLanguage].midiInfo_noDetected.replace(
            currentLanguage === 'es' ? "No detectado" : "Not detected",
            output.name
          );
        updateLocalControl();
        foundOutput = true;
        break;
      }
      if (!foundOutput) {
        document.getElementById("midiInfo").textContent = translations[currentLanguage].midiInfo_noDetected;
        document.getElementById("midiInfo").style.color = "red";
      }
      for (let input of midiAccess.inputs.values()) {
        input.onmidimessage = handleMIDIMessage;
      }
    }
    
    function handleMIDIMessage(event) {
      let [command, data1, data2] = event.data;
      let now = performance.now();
      
      if ((command & 0xF0) === 0xB0 && data1 === 64) {
        if (data2 >= 64) {
          sustainPedalActive = true;
          console.log("Pedal de sustain activado.");
        } else {
          sustainPedalActive = false;
          console.log("Pedal de sustain liberado.");
          if (midiOutput) {
            midiOutput.send([0xB0, 64, 0]);
            console.log("Enviando se√±al de pedal liberado (OFF).");
          }
          activeScoreEvents.forEach(eventObj => {
            if (eventObj.pendingRelease) {
              eventObj.scoreNotes.forEach(scoreNote => {
                if (midiOutput) midiOutput.send([0x80, scoreNote, 0]);
              });
              eventObj.pendingRelease = false;
            }
          });
          activeScoreEvents = activeScoreEvents.filter(evObj => evObj.physicalKeys.length > 0);
        }
        return;
      }
      
      if (command === 0x90 && data2 > 0) {
        midiBuffer.add(data1);
        if (now - lastNoteTime > noteGroupingTime) {
          setTimeout(() => {
            if (midiBuffer.size > 0) {
              checkUserInput(data2);
            }
          }, noteGroupingTime);
        }
        lastNoteTime = now;
      }
      else if (command === 0x80 || (command === 0x90 && data2 === 0)) {
        activeScoreEvents.forEach(eventObj => {
          if (eventObj.physicalKeys.includes(data1)) {
            eventObj.physicalKeys = eventObj.physicalKeys.filter(n => n !== data1);
            if (eventObj.physicalKeys.length === 0) {
              if (sustainPedalActive && eventObj.scoreNotes.includes(data1)) {
                if (midiOutput) {
                  midiOutput.send([0xB0, 64, 127]);
                  console.log("Enviando se√±al de pedal (ON) para mantener la nota", data1);
                }
              } else {
                if (sustainPedalActive) {
                  eventObj.pendingRelease = true;
                } else {
                  eventObj.scoreNotes.forEach(scoreNote => {
                    if (midiOutput) midiOutput.send([0x80, scoreNote, 0]);
                  });
                }
              }
            }
          }
        });
        activeScoreEvents = activeScoreEvents.filter(evObj => evObj.physicalKeys.length > 0 || evObj.pendingRelease);
      }
    }
    
    
    document.addEventListener("DOMContentLoaded", () => {
      fetch("https://cdn.jsdelivr.net/gh/rafgim/NUEVO@main/2Prelude%20in%20C%20Major.musicxml")
        .then(response => response.text())
        .then(musicXML => {
          currentEventIndex = 0;
          loadAndRender(musicXML);
        })
        .catch(error => console.error("Error al cargar la partitura por defecto:", error));
    });
    
    function resetState() {
      correctCount = 0;
      errorCount = 0;
      updateScoreboard();
      document.querySelector("h1").style.color = "#00008B";
      document.getElementById("scoreboard").style.backgroundColor = "green";
      document.getElementById("score").style.borderColor = "#00008B";
      document.getElementById("header").style.borderBottomColor = "#00008B";
      document.querySelector(".controls").style.borderBottomColor = "#00008B";
      window.scrollTo(0, 0);
    }
  </script>
</body>
</html>
